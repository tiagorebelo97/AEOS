# AEOS Containerization

This repository contains Docker/Podman containerization for the AEOS Access Control System.

## Quick Start

### Prerequisites

- Docker or Podman installed
- docker-compose or podman-compose installed

### Installation

1. **Clone the repository**:
   ```bash
   git clone https://github.com/tiagorebelo97/AEOS.git
   cd AEOS
   ```

2. **Start AEOS**:
   ```bash
   ./start.sh
   ```

That's it! The script will:
- Auto-detect Docker or Podman
- Create a secure database password
- Build the container images
- Start all services

### Access AEOS

- **Web Interface**: http://localhost:8080
- **HTTPS**: https://localhost:8443
- **Server Port**: localhost:2506
- **Lookup Port**: localhost:2505
- **Database**: localhost:5432

## Architecture

The AEOS deployment consists of three containers:

```
┌─────────────────┐
│  aeos-server    │  (Port 8080, 8443, 2506)
│  Application    │
│  Server         │
└────────┬────────┘
         │
         ├───────────┐
         │           │
┌────────▼────────┐ ┌▼───────────────┐
│  aeos-lookup    │ │ aeos-database  │
│  Lookup Server  │ │ PostgreSQL 14  │
│  (Port 2505)    │ │ (Port 5432)    │
└─────────────────┘ └────────────────┘
```

### Services

1. **aeos-database**: PostgreSQL 14 Alpine database
2. **aeos-lookup**: AEOS Lookup Server for network communication
3. **aeos-server**: AEOS Application Server

## Manual Setup

If you prefer to run commands manually:

### 1. Create Environment File

```bash
cp .env.example .env
# Edit .env and set POSTGRES_PASSWORD
```

### 2. Build Containers

```bash
docker-compose build
# or
podman-compose build
```

### 3. Start Services

```bash
docker-compose up -d
# or
podman-compose up -d
```

### 4. Check Status

```bash
docker-compose ps
# or
podman-compose ps
```

## Configuration

### Environment Variables

Create a `.env` file (or use the one auto-generated by `start.sh`):

```env
POSTGRES_PASSWORD=your_secure_password
```

### Changing Ports

Edit `docker-compose.yml` to change port mappings:

```yaml
services:
  aeos-database:
    ports:
      - "5433:5432"  # Change host port (left side)
```

### Java Memory Settings

Edit the Dockerfiles to adjust Java memory:

**Dockerfile.server**:
```dockerfile
ENV JAVA_OPTS="-Xms2048m -Xmx4096m"
```

**Dockerfile.lookup**:
```dockerfile
ENV JAVA_OPTS="-Xms512m -Xmx1024m"
```

## Managing Containers

### View Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f aeos-server
docker-compose logs -f aeos-lookup
docker-compose logs -f aeos-database
```

### Stop Services

```bash
docker-compose down
```

### Restart a Service

```bash
docker-compose restart aeos-server
```

### Remove Everything (including data)

```bash
docker-compose down -v
```

## Troubleshooting

If you encounter issues, see [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for detailed debugging steps.

### Quick Checks

1. **Check container status**:
   ```bash
   docker-compose ps
   ```

2. **View logs**:
   ```bash
   docker-compose logs -f aeos-server
   ```

3. **Check health**:
   ```bash
   docker inspect aeos-database --format '{{.State.Health.Status}}'
   ```

### Common Issues

- **Database unhealthy**: Wait 30-60 seconds for initialization, check logs
- **Containers in "Created" state**: Check logs for errors, verify dependencies
- **Port conflicts**: Change ports in docker-compose.yml or stop conflicting services
- **Network issues**: Restart with `docker-compose down && docker-compose up -d`

## Development

### Building from Source

```bash
# Build without cache
docker-compose build --no-cache

# Build specific service
docker-compose build aeos-server
```

### Accessing Container Shell

```bash
docker exec -it aeos-server /bin/bash
docker exec -it aeos-lookup /bin/bash
docker exec -it aeos-database /bin/bash
```

### Copying Files

```bash
# From container to host
docker cp aeos-server:/opt/aeos/logs/server.log ./

# From host to container
docker cp ./config.properties aeos-server:/opt/aeos/config/
```

## File Structure

```
AEOS/
├── docker-compose.yml          # Container orchestration
├── Dockerfile.server           # AEOS Server image
├── Dockerfile.lookup           # AEOS Lookup image
├── start.sh                    # Quick start script
├── .env.example                # Example environment file
├── .gitignore                  # Git ignore file
├── CONTAINERIZATION.md         # This file
├── TROUBLESHOOTING.md          # Detailed troubleshooting guide
└── scripts/
    ├── entrypoint.sh           # Server entrypoint
    ├── healthcheck.sh          # Server health check
    ├── lookup-entrypoint.sh    # Lookup entrypoint
    └── lookup-healthcheck.sh   # Lookup health check
```

## Security Considerations

1. **Change default password**: Always set a strong `POSTGRES_PASSWORD` in `.env`
2. **Network isolation**: Containers use a dedicated bridge network
3. **Non-root user**: Consider running containers as non-root user (future enhancement)
4. **HTTPS**: Use HTTPS (port 8443) for production
5. **Firewall**: Restrict access to exposed ports as needed

## Performance Tuning

### Database

Edit `docker-compose.yml` to add PostgreSQL tuning:

```yaml
services:
  aeos-database:
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
```

### Java Applications

Adjust memory in Dockerfiles based on available RAM:

- **Minimum**: Server 2GB, Lookup 512MB
- **Recommended**: Server 4GB, Lookup 1GB
- **High-load**: Server 8GB, Lookup 2GB

## Backup and Restore

### Backup Database

```bash
# Create backup
docker exec aeos-database pg_dump -U aeos aeos > backup.sql

# Or use docker-compose
docker-compose exec aeos-database pg_dump -U aeos aeos > backup.sql
```

### Restore Database

```bash
# Restore from backup
cat backup.sql | docker exec -i aeos-database psql -U aeos aeos

# Or use docker-compose
cat backup.sql | docker-compose exec -T aeos-database psql -U aeos aeos
```

### Backup Volumes

```bash
# Stop containers
docker-compose down

# Backup volume
docker run --rm -v aeos-copilot-make-program-a-container_aeos-db-data:/data -v $(pwd):/backup alpine tar czf /backup/db-backup.tar.gz -C /data .

# Restore volume
docker run --rm -v aeos-copilot-make-program-a-container_aeos-db-data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/db-backup.tar.gz"

# Start containers
docker-compose up -d
```

## Upgrading

### AEOS Version

To upgrade AEOS to a new version:

1. Edit `Dockerfile.server` and `Dockerfile.lookup`
2. Change `AEOS_VERSION` environment variable
3. Rebuild containers:
   ```bash
   docker-compose build --no-cache
   docker-compose up -d
   ```

### Container Images

```bash
# Pull latest base images
docker-compose pull

# Rebuild
docker-compose build --no-cache
docker-compose up -d
```

## Support

- **Troubleshooting Guide**: See [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
- **Technical Documentation**: See `aeos_technical_help_en_compressed.pdf`
- **Issues**: https://github.com/tiagorebelo97/AEOS/issues

## License

See repository license.
